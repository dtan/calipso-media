<script type="text/javascript">
$(function(){
    
    // setup common ajax setting
    $.ajaxSetup({
        url: '/media/update',
        type: 'POST',
        async: false,
        timeout: 500
    });

    // sortable
    $( ".sortable" ).sortable({ 	    	
	    opacity: 0.6,
	    placeholder: 'gallery-image-highlight',
	    appendTo: '.gallery-images',
	    containment: '.gallery-images',
	    tolerance: 'pointer',
	    delay: 100,
	    update: function(event, ui) { 
	    	var orderArray = $('.gallery-images').sortable('toArray'); 
      		var html = $.ajax({
      			url: '/gallery/upsert',        		
                data: { 'mediaGallery' : { url: '<%= gallery.url %>', sortOrder: orderArray}, type:'json' }
            }).responseText;    
            console.dir(html);                   
	    }
	});

    // call inlineEdit
    $('.editable').inlineEdit({      
       buttons: '',
       cancelOnBlur: true,  
        save: function(event, data) {

        	var id = this.id;
        	var name = data.value;

            var html = $.ajax({
                data: { 'media' : { _id : id, name: name}, type:'json' }
            }).responseText;            
            
            return html === 'OK' ? true : false;
        }
    });

});

function getGalleryUrl() {
  return "<%= gallery.url %>";
}

</script>

<div class="gallery">
	<h2 class="gallery-title"><%= gallery.name %></h2>
	<div class="gallery-description"><%- gallery.description %></div>
	<% if(user.isAdmin) { %>  	  
	  <div id="dropbox">
            <span class="message">Drop images here to upload. <br /><i>(they will only be visible to you)</i></span>
      </div>
      <div class="preview">		
		<div class="progressHolder">
			<div class="progress"></div>
		</div>
	</div>
	<% } %>
	<ul class="gallery-images <%= user.isAdmin ? "sortable" : "" %>">
	<% 
	media.forEach(function(item) {	
		%>
			<li id="<%= item._id %>">				
				<a href="/gallery/show/<%= gallery.url %>/image/<%= item._id %>" title="<%= item.name %>">
					<img src="<%- item.thumb ? item.thumb : item.path %>" class="gallery-list-image" alt="<%= item.name %>" />
				</a>																
				<div class='<%= user.isAdmin ? "editable" : "" %>' title='<%= user.isAdmin ? "Click to edit ..." : "" %>' id='<%= item._id %>'><%= item.name %></div>				
			</li>
		<%		
	});
	%>
	</ul>
	<br class="clear">

	<script type="text/javascript" src="/js/jquery.inlineedit.js"></script>
	<script type="text/javascript" src="/js/jquery.ui.touch-punch.min.js"></script>	
	<script type="text/javascript" src="/js/jquery-ui-1.8.16.custom.min.js"></script>
	<script type="text/javascript" src="/js/jquery.filedrop.js"></script>
	<script type="text/javascript" src="/js/filedrop.js"></script>
	
</div>